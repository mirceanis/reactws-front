machine:
  environment:
    YARN_VERSION: 1.2.1
    ANDROID_HOME: /usr/local/android-sdk-linux
    PATH: "${ANDROID_HOME}/tools:${ANDROID_HOME}/platform-tools:${PATH}:${HOME}/.yarn/bin:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"
#    JAVA_OPTIONS: "-Xms2048m -XX:-UseGCOverheadLimit -XX:+UseConcMarkSweepGC"
    _JAVA_OPTIONS: "-Xms1024M -Xmx1536M -XX:-UseGCOverheadLimit -XX:+UseConcMarkSweepGC"
    TERM: dumb
  node:
    version: v8.0.0
  java:
    version: oraclejdk8
dependencies:
  pre:
    - |
      if [[ ! -e ~/.yarn/bin/yarn || $(yarn --version) != "${YARN_VERSION}" ]]; then
        echo "Download and install Yarn."
        curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version $YARN_VERSION
      else
        echo "The correct version of Yarn is already installed."
      fi
    - echo y | android update sdk --no-ui --all --filter "platform-tools, tools"
    - mkdir -p ${HOME}/.android && touch ${HOME}/.android/repositories.cfg
    - yes | $ANDROID_HOME/tools/bin/sdkmanager --update
    - yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses
    - yes | $ANDROID_HOME/tools/bin/sdkmanager "build-tools;26.0.2"
    - yes | $ANDROID_HOME/tools/bin/sdkmanager "platforms;android-26"
    - yes | $ANDROID_HOME/tools/bin/sdkmanager "tools" "platform-tools"
#    - yes | $ANDROID_HOME/tools/bin/sdkmanager "extras;android;m2repository" "extras;google;m2repository"
    
  override:
    - yarn install
    - cd android && ./gradlew tasks --all
    - cd android && ./gradlew dependencies
  cache_directories:
    - ~/.yarn
    - ~/.cache/yarn
    - ~/.gradle
    - android/.gradle
    - ~/.android
    - $ANDROID_HOME
general:
  artifacts:
    - "android/app/build/reports"
    - "android/app/build/outputs/apk"
compile:
  override:
    - cd android && ./gradlew deliverArchives
test:
  override:
#    - yarn test -- --maxWorkers 2
    - cd android && ./gradlew lint
    - cd android && ./gradlew test
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
